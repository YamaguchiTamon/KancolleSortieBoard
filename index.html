<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>出撃当番表</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
</head>
<body>
<style>
  body {
    margin: 20px;
    font-family: "arial unicode ms",sans-serif;
  }
  .kcsb_toolbar {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .kcsb_apptitle {
    margin-right: 32px;
  }
  .kcsb_view_selector_area {
    margin-left: 20px;
    font-size: 0.8em;
  }
  .kcsb_document_container {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    align-items: flex-start;
  }
  .kcsb_ship_container {
    flex-basis: 50%;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    background: #7682a6;
  }
  .kcsb_operation_container {
    flex-basis: 50%;
    padding: 0px;
    background: #7682a6;
  }
  .kcsb_dock {
    padding: 0px;
    width: 91px;
    height: 35px;
  }
  .kcsb_item {
    padding: 2px;
    width: 80px;
    height: 28px;
    border: solid #000000;
    border-width: 1px 1px 1px 5px;
    background-color: #303030;
    color: #FFFFFF;
    overflow: hidden;
    font-size: 0.8em;
    display: table-cell;
    vertical-align: middle;
  }
  .kcsb_item:hover {
    cursor: pointer;
  }
  .kcsb_fleet_container_area {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .kcsb_fleet_area {
    padding: 0px;
    margin-right: 1px;
    margin-bottom: 1px;
    height: 224px;
    background: #1f337b;
  }
  .kcsb_fleet_area p {
    padding: 1px;
    color: #ffffff;
    border: solid #000000;
    border-width: 0px 0px 0px 8px;
  }
  .kcsb_fleet_ship_area {
    padding: 0px;
    width: 180px;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .kcsb_fleet_ship {
    padding: 2px;
    width: 80px;
    height: 28px;
    border: solid #000000;
    border-width: 1px 1px 1px 5px;
    background-color: #303030;
    color: #ffffff;
    overflow: hidden;
    font-size: 0.8em;
    display: table-cell;
    vertical-align: middle;
  }
  .kcsb_fleet_ship:hover {
    cursor: pointer;
  }
  .kcsb_operation_label {
    margin-bottom: 1px;
    background-color: #285b6c;
    color: #ffffff;
  }
  .kcsb_operation_label::before{
    content: "－";
    position: absolute;
    right: 20px;
  }
  .kcsb_operation_label.active::before{
    content: "＋";
  }  
  .kcsb_debug_console {
    width: 100%;
    height: 200px;
    border: 0px;
    background: #aaaaaa;
    overflow: auto;
  }
</style>

<div id="kcsa">
  <div id="kcsb_toolbar" class="kcsb_toolbar">
    <div class="kcsb_apptitle">出撃当番表</div>
    <input type="file" id="selfile" accept="application/json" />
    <input type="button" id="savebtn" value="SAVE" onclick="onSaveButtonClicked();" />
    <div class="kcsb_view_selector_area">
      <label for="view_selector">表示</label>
      <select id="view_selector" name="view_selector">
        <option value="11">艦 | 作戦</option>
        <option value="01">作戦</option>
        <option value="10">艦</option>
      </select>
    </div>
  </div>
  <div id="kcsb_document_container" class="kcsb_document_container">
    <div id="kcsb_ship_container" class="kcsb_ship_container">
    </div>
    <div id="kcsb_operation_container" class="kcsb_operation_container">
    </div>
  </div>
  <div id="kcsb_debug_console" class="kcsb_debug_console">
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="jquery.ui.touch-punch.min.js"></script>
<script src="shipDB.js"></script>
<script src="defaultFleetData.js"></script>
<script src="eventData.js"></script>
<script>
  let allowMultipleFleetTags = true;

  let ships = [];
  {
    const dataLen = defaultFleetData.length;
    for(let i = 0; i < dataLen; ++i) {
      const shipData = defaultFleetData[i];
      const typeData = shipDB[shipData.id];
      const ship = {
        type: typeData.stype,
        name: typeData.name,
        lv: shipData.lv,
        fleetTags:{}
      };
      ships.push(ship);
    }
    ships.push({ type:0, name:'[未所持艦]', fleetTags:{} });
  }

  const shipColors = [
    '#333333', //  0: ?
    '#222244', //  1: 海防艦
    '#000044', //  2: 駆逐艦
    '#002244', //  3: 軽巡洋艦
    '#003344', //  4: 重雷装巡洋艦
    '#002200', //  5: 重巡洋艦
    '#223300', //  6: 航空巡洋艦
    '#444411', //  7: 軽空母
    '#550000', //  8: 高速戦艦
    '#440000', //  9: 戦艦
    '#442200', // 10: 航空戦艦
    '#333300', // 11: 空母
    '#333333', // 12: ?
    '#111133', // 13: 潜水艦
    '#220044', // 14: 潜水空母
    '#333333', // 15: 輸送艦
    '#444444', // 16: 水上機母艦
    '#333333', // 17: 揚陸艦
    '#222200', // 18: 装甲空母
    '#333333', // 19: 工作艦
    '#222222', // 20: 潜水母艦
    '#223333', // 21: 練習巡洋艦
    '#333333', // 22: 補給艦
];

  let loadFromJsonFile = function(file) {
    let reader = new FileReader();
    reader.readAsText(file[0]);
    reader.onload = function(ev){
      const data = JSON.parse(reader.result);
      if(data.hasOwnProperty('ships')) {
        ships = data.ships;
        updateHomeportView();
      }
      let fileEventId = 'unknown';
      if(data.hasOwnProperty('eventId')) {
        fileEventId = data.eventId;
      }
      if(fileEventId == eventId) {
        if(data.hasOwnProperty('fleets')) {
          fleets = data.fleets;
          updateOperationView();
        }        
      }

      document.getElementById('kcsb_debug_console').innerText = reader.result;
    }
  }
  document.getElementById('selfile').addEventListener('change',function(evt){
    let file = evt.target.files;
    loadFromJsonFile(file);
    evt.target.value = '';
  },false);
      
  let saveAsJsonFile = function() {
    const jsonStr = JSON.stringify({eventId: eventId, ships: ships, fleets: fleets});
    let blob = new Blob([jsonStr], {type:"text/plan"});
    let link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'toubanhyou.json';
    link.click();
  }
  let onSaveButtonClicked = function(){
    saveAsJsonFile();
  }

  let canRetainFleetTag = function(shipId, fleetTag) {
    if(allowMultipleFleetTags) {
      return true;
    }
    const shipData = ships[shipId];
    const currentFleetTags = Object.keys(shipData.fleetTags);
    if((0 !== currentFleetTags.length) && (currentFleetTags[0] != fleetTag)) {
      return false;
    }
    return true;    
  }
  let retainFleetTag = function(shipId, fleetTag, onBound) {
    if(!canRetainFleetTag(shipId, fleetTag)) {
      return false;
    }
    let shipData = ships[shipId];
    if(shipData.fleetTags.hasOwnProperty(fleetTag)) {
      shipData.fleetTags[fleetTag]++;
    } else {
      shipData.fleetTags[fleetTag] = 1;
      onBound(shipId, fleetTag);
    }
  }
  let releaseFleetTag = function(shipId, fleetTag, onUnbound) {
    let shipData = ships[shipId];
    if(1 < shipData.fleetTags[fleetTag]) {
      shipData.fleetTags[fleetTag]--;
    } else {
      delete shipData.fleetTags[fleetTag];
      if(onUnbound) {
        onUnbound(shipId, fleetTag);
      }
    }
  }
  let appendFleetShip = function(fleetId, shipId, onBound) {
    let fleetData = fleets[fleetId];
    fleetData.ships.push(shipId);
    retainFleetTag(shipId, fleetData.fleetTag, onBound);
  }
  let removeFleetShip = function(fleetId, shipId, onUnbound) {
    let fleetData = fleets[fleetId];
    fleetData.ships = fleetData.ships.filter(val => val !== shipId);
    releaseFleetTag(shipId, fleetData.fleetTag, onUnbound);
  }

  let getHomeportShipDivId = function(shipId) {
    return 'homeport_ship_div_' + shipId;
  }

  let updateHomeportView = function() {
    let shipContainerOld = document.getElementById('kcsb_ship_container');
    let shipContainer = shipContainerOld.cloneNode(false);
    shipContainerOld.parentNode.replaceChild(shipContainer, shipContainerOld);
    const shipsLength = ships.length;
    for(let shipId=0; shipId<shipsLength; shipId++) {
      let shipData = ships[shipId];
      let dockDiv = document.createElement('div');
      dockDiv.className = 'kcsb_dock';
      shipContainer.appendChild(dockDiv);
      let shipDiv = document.createElement('div');
      shipDiv.className = 'kcsb_item';
      shipDiv.id = getHomeportShipDivId(shipId);
      shipDiv.style.backgroundColor = shipColors[shipData.type];
      shipDiv.textContent = shipData.name;
      updateShipFleetTags(shipDiv, Object.keys(shipData.fleetTags));    
      shipDiv.customInfo = {
        shipId: shipId
      };
      dockDiv.appendChild(shipDiv);
    }
    $('.kcsb_item').draggable({
      start: function(e,ui) {
        let currentOffset = $(this).offset();
        this.customInfo.offsetOrg = {
          top: currentOffset.top,
          left: currentOffset.left
        };
      },
      stop: function(e,ui) {
        $(this).offset(this.customInfo.offsetOrg);
      }
    });
  }

  let updateShipFleetTags = function(shipDiv, shipFleetTags) {
    if(null === shipDiv) {
      return;
    }
    const extagNode = shipDiv.childNodes[1];
    if(extagNode) {
      shipDiv.removeChild(extagNode);
    }
    if(0 < shipFleetTags.length) {
      shipDiv.style.borderColor = fleetTags[shipFleetTags[0]].color;
      if(1 < shipFleetTags.length) {
        let fleetTagContainer = document.createElement('div');
        fleetTagContainer.style.position = 'absolute';
        fleetTagContainer.style.right = '0px';
        fleetTagContainer.style.top = '0px';
        for(let i=1; i<shipFleetTags.length; i++) {
          let fleetTagNode = document.createElement('div');
          fleetTagNode.style.width = '8px';
          fleetTagNode.style.height = '4px';
          fleetTagNode.style.backgroundColor = fleetTags[shipFleetTags[i]].color;
          fleetTagContainer.appendChild(fleetTagNode);
        }
        shipDiv.appendChild(fleetTagContainer);
      }
    } else {
      shipDiv.style.borderColor = '#000000';
    }
  }

  let getFleetDivId = function(fleetId) {
    return 'fleet_div_' + fleetId;
  }

  let updateFleetStateView = function(fleetId) {
    let fleetDiv = document.getElementById(getFleetDivId(fleetId));
    const fleetData = fleets[fleetId];
    let hasMultipleFleetTags = false;
    const fleetShipsLength = fleetData.ships.length;
    for(let i=0; i<fleetShipsLength; i++) {
      const shipData = ships[fleetData.ships[i]];
      if(1 < Object.keys(shipData.fleetTags).length) {
        hasMultipleFleetTags = true;
        break;
      }
    }
    if(hasMultipleFleetTags) {
      fleetDiv.style.backgroundColor = '#8f0404';
    } else {
      fleetDiv.style.backgroundColor = '#1f337b';
    }
  }

  let updateShipView = function(shipId, triggerFleetId) {
    let shipData = ships[shipId];
    const fleetTags = Object.keys(shipData.fleetTags);
    updateShipFleetTags(document.getElementById(getHomeportShipDivId(shipId)), fleetTags);
    const fleetsLength = fleets.length;
    for(let fleetId=0; fleetId<fleetsLength; fleetId++) {
      if(triggerFleetId === fleetId) {
        continue;
      }
      const fleetData = fleets[fleetId];
      if(fleetData.ships.includes(shipId)) {
        let fleetShipDiv = document.getElementById(getFleetShipDivId(fleetId, shipId));
        updateShipFleetTags(fleetShipDiv, fleetTags);
        updateFleetStateView(fleetId);
      }
    }
  }

  let updateOperationView = function() {
    let operationContainerOld = document.getElementById('kcsb_operation_container');
    let operationContainer = operationContainerOld.cloneNode(false);
    operationContainerOld.parentNode.replaceChild(operationContainer, operationContainerOld);
    let fleetContainers = [];
    for(let i=0; i<operations.length; i++) {
      let operationData = operations[i];
      let operationDiv = document.createElement('div');
      operationDiv.className = 'kcsb_operation_area';
      operationDiv.id = 'kcsb_operation_' + i;
      operationContainer.appendChild(operationDiv);
      let operationLabel = document.createElement('p');
      operationLabel.className = 'kcsb_operation_label';
      operationLabel.textContent = operationData.name;
      $(operationLabel).click(function(){
        $(this).toggleClass('active');
        $(this).next('div').slideToggle();
      });
      operationDiv.appendChild(operationLabel);
      let fleetContainer = document.createElement('div');
      fleetContainer.className = 'kcsb_fleet_container_area';
      operationDiv.appendChild(fleetContainer);
      fleetContainers.push(fleetContainer);
    }
    for(let fleetId=0; fleetId<fleets.length; fleetId++) {
      let fleetData = fleets[fleetId];
      if(!fleetData.visible) {
        //continue;
      }
      let fleetDiv = document.createElement('div');
      fleetDiv.className = 'kcsb_fleet_area';
      fleetDiv.id = getFleetDivId(fleetId);
      fleetContainer = fleetContainers[fleetData.oprationId];
      fleetContainer.appendChild(fleetDiv);
      let fleetLabel = document.createElement('p');
      fleetLabel.textContent = fleetData.name;
      fleetLabel.style.borderColor = fleetTags[fleetData.fleetTag].color;
      fleetDiv.appendChild(fleetLabel);
      let shipContainer = document.createElement('div');
      shipContainer.className = 'kcsb_fleet_ship_area';
      fleetDiv.appendChild(shipContainer);
      fleetDiv.customInfo = {
        fleetId: fleetId
      }
      fleetData.ships.forEach(function(shipId) {
        let shipDiv = createFleetShip(shipId, fleetId);
        shipContainer.appendChild(shipDiv);
      });
      updateFleetStateView(fleetId);
    }
    $('.kcsb_fleet_area').droppable({
      activate: function(e,ui) {
      },
      over: function(e,ui) {
        //$(this)
        //  .css('background', '#e0ffff')
        //  .css('border', '2px solid #00bfff');
      },
      out: function(e,ui) {
      },
      drop: function(e,ui) {
        let shipDiv = ui.draggable[0];
        let shipContainer = $(this).find('.kcsb_fleet_ship_area')[0];
        if(shipDiv.parentNode === shipContainer) {
          shipDiv.customInfo.canceled = true;
        }
        const shipId = shipDiv.customInfo.shipId;
        if(canDrop(this, shipId)) {
          const fleetId = this.customInfo.fleetId;
          let fleetData = fleets[fleetId];
          appendFleetShip(fleetId, shipId, function() { updateShipView(shipId, fleetId); });
          let shipDiv2 = createFleetShip(shipId, fleetId);
          shipContainer.appendChild(shipDiv2);
          updateFleetStateView(fleetId);
        } else {
          shipDiv.customInfo.canceled = true;
        }
      }
    });
  }

  let canDrop = function(target, shipId) {
    // check fleet tag
    if(!canRetainFleetTag(shipId, fleets[target.customInfo.fleetId].fleetTag)) {
      return false;
    }

    // check same ship existance
    let result = true;
    $(target).find('.kcsb_fleet_ship').each(function(index, elem) {
      if(elem.customInfo.shipId === shipId) {
        result = false;
        return;
      }
    });
    return result;
  }

  let getFleetShipDivId = function(shipId, fleetId) {
    return 'kcsb_fleet_ship_div_' + fleetId + '_' + shipId;
  }

  let createFleetShip = function(shipId, fleetId) {
    let shipData = ships[shipId];
    let shipDiv = document.createElement('div');
    shipDiv.className = 'kcsb_fleet_ship';
    shipDiv.id = getFleetShipDivId(fleetId, shipId);
    shipDiv.style.backgroundColor = shipColors[shipData.type];
    shipDiv.textContent = shipData.name;
    updateShipFleetTags(shipDiv, Object.keys(shipData.fleetTags));    
    shipDiv.customInfo = {
      shipId: shipId,
      fleetId: fleetId
    };
    $(shipDiv).draggable({
      start: function(e,ui) {
        let currentOffset = $(this).offset();
        this.customInfo.canceled = false;
        this.customInfo.offsetOrg = {
          top: currentOffset.top,
          left: currentOffset.left
        };
      },
      stop: function(e,ui) {
        if(this.customInfo.canceled) {
          $(this).offset(this.customInfo.offsetOrg);
        } else {
          this.parentNode.removeChild(this);
          const shipId = this.customInfo.shipId;
          removeFleetShip(fleetId, shipId, function(){ updateShipView(shipId, fleetId); });
          updateFleetStateView(fleetId);
        }
      }
    });
    return shipDiv;
  }

  let viewSelector = document.getElementById('view_selector');
  viewSelector.addEventListener('change', (event) => {
    const value = event.target.value;
    const visibleHomeport = value.charAt(0) == '1';
    const visibleOperation = value.charAt(1) == '1';

    let homeportNode = document.getElementById('kcsb_ship_container');
    if(visibleHomeport) {
      homeportNode.style.display = 'flex';
      homeportNode.style.flexBasis = visibleOperation ? '50%' : '100%';
    } else {
      homeportNode.style.display = 'none';
    }

    let operationNode = document.getElementById('kcsb_operation_container');
    if(visibleOperation) {
      operationNode.style.display = 'inline';
      operationNode.style.flexBasis = visibleHomeport ? '50%' : '100%';
    } else {
      operationNode.style.display = 'none';
    }
  });

  window.addEventListener('DOMContentLoaded', function(){
    updateHomeportView();
    updateOperationView();
  });

</script>
</body>
</html>
