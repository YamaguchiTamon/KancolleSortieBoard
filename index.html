<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>出撃当番表</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
</head>
<body>
<style>
  body {
    margin: 10px;
    font-family: "arial unicode ms",sans-serif;
  }
  .kcsb_toolbar {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .kcsb_apptitle {
    margin-right: 32px;
  }
  .kcsb_file_selector_area {
    margin-left: 4px;
    margin-right: 4px;
    margin-bottom: 4px;
    font-size: 0.8em;
    background-color: #285b6c;
    color: #ffffff;
  }
  .kcsb_view_selector_area {
    margin-left: 4px;
    margin-right: 4px;
    margin-bottom: 4px;
    font-size: 0.8em;
    background-color: #285b6c;
    color: #ffffff;
  }
  .kcsb_document_container {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    align-items: flex-start;
  }
  .kcsb_homeport_toolbar {
    margin-left: 4px;
    margin-right: 4px;
    margin-bottom: 4px;
    background-color: #285b6c;
    color: #ffffff;
    font-size: 0.8em;
  }
  .kcsb_ship_container {
    flex-basis: 50%;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    background: #7682a6;
  }
  .kcsb_operation_container {
    flex-basis: 50%;
    padding: 0px;
    background: #7682a6;
  }
  .kcsb_dock {
    padding: 0px;
    width: 91px;
    height: 35px;
  }
  .kcsb_item {
    padding: 2px;
    width: 80px;
    height: 28px;
    border: solid #000000;
    border-width: 1px 1px 1px 5px;
    background-color: #303030;
    color: #FFFFFF;
    overflow: hidden;
    font-size: 0.8em;
    display: table-cell;
    vertical-align: middle;
  }
  .kcsb_item:hover {
    cursor: pointer;
  }
  .kcsb_taskforce_container_area {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .kcsb_taskforce_area {
    padding: 0px;
    margin-right: 1px;
    margin-bottom: 1px;
    height: 224px;
    background: #1f337b;
  }
  .kcsb_taskforce_area p {
    padding: 1px;
    color: #ffffff;
    border: solid #000000;
    border-width: 0px 0px 0px 8px;
  }
  .kcsb_taskforce_ship_area {
    padding: 0px;
    width: 180px;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .kcsb_taskforce_ship {
    padding: 2px;
    width: 80px;
    height: 28px;
    border: solid #000000;
    border-width: 1px 1px 1px 5px;
    background-color: #303030;
    color: #ffffff;
    overflow: hidden;
    font-size: 0.8em;
    display: table-cell;
    vertical-align: middle;
  }
  .kcsb_taskforce_ship:hover {
    cursor: pointer;
  }
  .kcsb_operation_label {
    margin-bottom: 1px;
    background-color: #285b6c;
    color: #ffffff;
  }
  .kcsb_operation_label::before{
    content: "－";
    position: absolute;
    right: 20px;
  }
  .kcsb_operation_label.active::before{
    content: "＋";
  }  
  .kcsb_debug_console {
    width: 100%;
    height: 200px;
    border: 0px;
    background: #aaaaaa;
    overflow: auto;
  }
</style>

<div id="kcsa">
  <div id="kcsb_toolbar" class="kcsb_toolbar">
    <div class="kcsb_apptitle">出撃当番表</div>
    <div id="kcsb_homeport_toolbar" class="kcsb_homeport_toolbar">
      <label for="sort_selector">艦ソート</label>
      <select id="sort_selector" name="sort_selector">
        <option value="typeDesc">艦種 降順</option>
        <option value="typeAsc">艦種 昇順</option>
        <option value="lvDesc">Lv 降順</option>
        <option value="lvAsc">Lv 昇順</option>
        <option value="tagDesc">札 降順</option>
        <option value="tagAsc">札 昇順</option>
      </select>
    </div>
    <div class="kcsb_view_selector_area">
      <label for="view_selector">表示</label>
      <select id="view_selector" name="view_selector">
        <option value="11">艦 | 作戦</option>
        <option value="01">作戦</option>
        <option value="10">艦</option>
      </select>
    </div>
    <div class="kcsb_file_selector_area">艦隊データ読み込み <input type="file" id="importFleetJson" accept="application/json" /></div>
    <div class="kcsb_file_selector_area">出撃データ読み込み <input type="file" id="importSortieJson" accept="application/json" /></div>
    <input type="button" id="savebtn" value="出撃データダウンロード" onclick="onSaveButtonClicked();" />
  </div>
  <div id="kcsb_document_container" class="kcsb_document_container">
    <div id="kcsb_ship_container" class="kcsb_ship_container">
    </div>
    <div id="kcsb_operation_container" class="kcsb_operation_container">
    </div>
  </div>
  <!-- <div id="kcsb_debug_console" class="kcsb_debug_console">
  </div> -->
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="jquery.ui.touch-punch.min.js"></script>
<script src="shipDB.js"></script>
<!-- <script src="defaultFleetData.js"></script> -->
<script src="eventData.js"></script>
<script>
  let allowMultipleSortieTags = true;

  let sameShipListTable = [];

  let ships = [];
  let nonPossesionShipLocalId = -1;

  let importFleetData = function(fleetData)
  {
    ships = [];
    fleetData.forEach((shipData, i) => {
      const dbShipData = shipDB[shipData.id];
      let ship;
      if(dbShipData !== null && dbShipData !== undefined) {
        ship = {
          id: shipData.id,
          type: dbShipData.stype,
          name: dbShipData.name,
          lv: shipData.lv,
          sortieTags:{}
        };
      } else {
        ship = {
          id: shipData.id,
          type: 0,
          name: '[未確認艦:' + shipData.id + ']',
          lv: shipData.lv,
          sortieTags:{}
        };
      }
      ships.push(ship);
      let sameShipList = sameShipListTable[dbShipData.id];
      if(null === sameShipList || undefined === sameShipList) {
        sameShipListTable[dbShipData.id] = [];
        sameShipList = sameShipListTable[dbShipData.id];
      }
      sameShipList.push(i);
    });
    ships.push({ id:0, type:0, name:'[未所持艦]', lv: 0, sortieTags:{} });
    nonPossesionShipLocalId = ships.length - 1;
    sameShipListTable[0] = [nonPossesionShipLocalId];
    sameShipListTable.forEach((sameShipList) => {
      sameShipList.sort((a, b) => {
        return ships[b].lv - ships[a].lv;  
      });
    });
  }

  if('defaultFleetData' in window) {
    importFleetData(defaultFleetData);
  } else {
    importFleetData([]);
  }

  const shipColors = [
    '#333333', //  0: ?
    '#222244', //  1: 海防艦
    '#000044', //  2: 駆逐艦
    '#002244', //  3: 軽巡洋艦
    '#003344', //  4: 重雷装巡洋艦
    '#002200', //  5: 重巡洋艦
    '#223300', //  6: 航空巡洋艦
    '#444411', //  7: 軽空母
    '#550000', //  8: 高速戦艦
    '#440000', //  9: 戦艦
    '#442200', // 10: 航空戦艦
    '#333300', // 11: 空母
    '#333333', // 12: ?
    '#111133', // 13: 潜水艦
    '#220044', // 14: 潜水空母
    '#333333', // 15: 輸送艦
    '#444444', // 16: 水上機母艦
    '#333333', // 17: 揚陸艦
    '#222200', // 18: 装甲空母
    '#333333', // 19: 工作艦
    '#222222', // 20: 潜水母艦
    '#223333', // 21: 練習巡洋艦
    '#333333', // 22: 補給艦
  ];

  let searchRequiredShipLocalId = function(dbShipId, lvIndex) {
    const sameShipList = sameShipListTable[dbShipId];
    if(null === sameShipList || undefined === sameShipList) {
      return nonPossesionShipLocalId;
    }
    if(sameShipList.length <= lvIndex) {
      lvIndex = sameShipList.length - 1;
    }
    return sameShipList[lvIndex];
  }

  let shipNameTable = null;

  let resolveShipName = function(name) {
    if(!shipNameTable) {
      shipNameTable = {};
      shipDB.forEach((shipData) => {
        if(shipData) {
          //if(shipNameTable[shipData.name]) {
          //  //error
          //  //'宗谷' and enemies have 2 or more db items.
          //}
          shipNameTable[shipData.name] = shipData.id;
        }
      });
    }
    const shipId = shipNameTable[name];
    if(!shipId) {
      return 0; // unknown ship
    }
    return shipId;
  }

  let postImport = function(changedShips, changedTaskForces) {
    if(changedShips) {
      updateHomeportView();
    }

    taskforces.forEach((taskforce) => {
      taskforce.ships = [];
    });

    // clear sortie tags
    ships.forEach((ship) => {
      ship.sortieTags = {};
    });
    taskforces.forEach((taskforce, taskforceId) => {
      taskforce.requiredShips.forEach((requiredShip) => {
        let id = requiredShip.id;
        if(undefined === id) {
          id = resolveShipName(requiredShip.name);
          requiredShip.id = id;
        }
        const localShipId = searchRequiredShipLocalId(id, requiredShip.lvIndex);
        appendTaskForceShip(taskforceId, localShipId, null);
      });
    });
    if(changedTaskForces) {
      updateOperationView();
    }
    ships.forEach((ship, localShipId) => {
      updateShipView(localShipId, -1);
    });
  }

  let importFleetJson = function(file) {
    let reader = new FileReader();
    reader.readAsText(file[0]);
    reader.onload = function(ev){
      const data = JSON.parse(reader.result);
      importFleetData(data);
      postImport(true, true);
    }
  }

  document.getElementById('importFleetJson').addEventListener('change',function(evt){
    let file = evt.target.files;
    importFleetJson(file);
    evt.target.value = '';
  },false);
      
  let importSortieJson = function(file) {
    let reader = new FileReader();
    reader.readAsText(file[0]);
    reader.onload = function(ev){
      const data = JSON.parse(reader.result);
      fileEventId = '';
      sortieTags = [];
      operations = [];
      taskforces = [];
      if(data.hasOwnProperty('eventId')) {
        fileEventId = data.eventId;
      }
      if(data.hasOwnProperty('sortieTags')) {
        sortieTags = data.sortieTags;
        if(data.hasOwnProperty('operations')) {
          operations = data.operations;
          if(data.hasOwnProperty('taskforces')) {
            taskforces = data.taskforces;
          }
        }
      }
      postImport(false, true);
    }
  }

  document.getElementById('importSortieJson').addEventListener('change',function(evt){
    let file = evt.target.files;
    importSortieJson(file);
    evt.target.value = '';
  },false);
      
  let saveAsJsonFile = function(filename, obj) {
    const jsonStr = JSON.stringify(obj);
    let blob = new Blob([jsonStr], {type:"text/plan"});
    let link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  let exportSortieData = function() {
    let shipIdTbl = {};
    taskforces.forEach((taskforceDataSrc) => {
      taskforceDataSrc.requiredShips = [];
      taskforceDataSrc.ships.forEach((localShipId) => {
        const shipDataSrc = ships[localShipId];
        let shipData = {
          id: shipDataSrc.id,
          lvIndex: 0,
          localId: localShipId
        };
        taskforceDataSrc.requiredShips.push(shipData);
        if(undefined == shipIdTbl[shipDataSrc.id]) {
          shipIdTbl[shipDataSrc.id] = [];
        }
        if(!shipIdTbl[shipDataSrc.id].includes(localShipId)) {
          shipIdTbl[shipDataSrc.id].push(localShipId);
        }
      });
    });

    Object.keys(shipIdTbl).forEach(function (key) {
      let shipLocalIdList = shipIdTbl[key];
      if(1 < shipLocalIdList.length) {
        shipLocalIdList.sort((a, b) => {
          return ships[b].lv - ships[a].lv;
        });
      }
    });

    taskforces.forEach((taskforceDataSrc) => {
      taskforceDataSrc.requiredShips.forEach((ship) => {
        ship.lvIndex = shipIdTbl[ship.id].indexOf(ship.localId);
        delete ship.localId;
      });
    });

    saveAsJsonFile('toubanhyou.json', {eventId: eventId, sortieTags: sortieTags, operations: operations, taskforces: taskforces});
  }

  let onSaveButtonClicked = function(){
    exportSortieData();
  }

  let canRetainSortieTag = function(shipId, sortieTag) {
    if(allowMultipleSortieTags) {
      return true;
    }
    const shipData = ships[shipId];
    const currentSortieTags = Object.keys(shipData.sortieTags);
    if((0 !== currentSortieTags.length) && (currentSortieTags[0] != sortieTag)) {
      return false;
    }
    return true;    
  }
  let retainSortieTag = function(shipId, sortieTag, onBound) {
    if(!canRetainSortieTag(shipId, sortieTag)) {
      return false;
    }
    let shipData = ships[shipId];
    if(shipData.sortieTags.hasOwnProperty(sortieTag)) {
      shipData.sortieTags[sortieTag]++;
    } else {
      shipData.sortieTags[sortieTag] = 1;
      const taskforcesLen = taskforces.length;
      for(tfId = 0; tfId < taskforcesLen; tfId++) {
        const tf = taskforces[tfId];
        if(tf.ships.includes(shipId)) {
          if(tf.allowedTags.includes(sortieTag)) {
            releaseSortieTag(shipId, tf.sortieTag, null);
          }
        }
      }
      if(onBound) {
        onBound(shipId, sortieTag);
      }
    }
  }
  let releaseSortieTag = function(shipId, sortieTag, onUnbound) {
    let shipData = ships[shipId];
    if(!shipData.sortieTags.hasOwnProperty(sortieTag)) {
      return;
    }
    if(1 < shipData.sortieTags[sortieTag]) {
      shipData.sortieTags[sortieTag]--;
    } else {
      delete shipData.sortieTags[sortieTag];
      if(0 === Object.keys(shipData.sortieTags).length) {
      // need to search a new sortie tag becasue the tag may be one of "allowedTags"
      const taskforcesLen = taskforces.length;
        for(tfId = 0; tfId < taskforcesLen; tfId++) {
          const tf = taskforces[tfId];
          if(tf.ships.includes(shipId)) {
            retainSortieTag(shipId, tf.sortieTag, null);
            break;
          }
        }
      }
      if(onUnbound) {
        onUnbound(shipId, sortieTag);
      }
    }
  }
  let hasAllowedSortieTag = function(shipId, allowedTags) {
    const shipData = ships[shipId];
    const allowedTagsLen = allowedTags.length;
    for(let i = 0; i < allowedTagsLen; i++) {
      const tag = allowedTags[i];
      if(shipData.sortieTags.hasOwnProperty(tag)) {
        return true;
      }
    }
    return false;
  }
  let appendTaskForceShip = function(taskforceId, shipId, onBound) {
    let taskforceData = taskforces[taskforceId];
    taskforceData.ships.push(shipId);
    if(!hasAllowedSortieTag(shipId, taskforceData.allowedTags)) {
      retainSortieTag(shipId, taskforceData.sortieTag, onBound);
    }
  }
  let removeTaskForceShip = function(taskforceId, shipId, onUnbound) {
    let taskforceData = taskforces[taskforceId];
    taskforceData.ships = taskforceData.ships.filter(val => val !== shipId);
    releaseSortieTag(shipId, taskforceData.sortieTag, onUnbound);
  }

  let getHomeportShipDivId = function(shipId) {
    return 'homeport_ship_div_' + shipId;
  }

  const sortComapreFunctions = {
    typeDesc: function(a, b) {
      let shipA = ships[a.firstChild.customInfo.shipId];
      let shipB = ships[b.firstChild.customInfo.shipId];
      return shipB.type - shipA.type;
    },
    typeAsc: function(a, b) {
      let shipA = ships[a.firstChild.customInfo.shipId];
      let shipB = ships[b.firstChild.customInfo.shipId];
      return shipA.type - shipB.type;
    },
    lvDesc: function(a, b) {
      let shipA = ships[a.firstChild.customInfo.shipId];
      let shipB = ships[b.firstChild.customInfo.shipId];
      return shipB.lv - shipA.lv;
    },
    lvAsc: function(a, b) {
      let shipA = ships[a.firstChild.customInfo.shipId];
      let shipB = ships[b.firstChild.customInfo.shipId];
      return shipA.lv - shipB.lv;
    },
    tagDesc: function(a, b) {
      const tagsB = ships[b.firstChild.customInfo.shipId].sortieTags;
      const keysA = Object.keys(ships[a.firstChild.customInfo.shipId].sortieTags);
      const keysB = Object.keys(ships[b.firstChild.customInfo.shipId].sortieTags);
      const tagA = keysA.length === 0 ? -1 : keysA[0];
      const tagB = keysB.length === 0 ? -1 : keysB[0];
      return tagB - tagA;
    },
    tagAsc: function(a, b) {
      const tagsB = ships[b.firstChild.customInfo.shipId].sortieTags;
      const keysA = Object.keys(ships[a.firstChild.customInfo.shipId].sortieTags);
      const keysB = Object.keys(ships[b.firstChild.customInfo.shipId].sortieTags);
      const tagA = keysA.length === 0 ? -1 : keysA[0];
      const tagB = keysB.length === 0 ? -1 : keysB[0];
      return tagA - tagB;
    },
  };

  let sortHomeportView = function(sortType) {
    let shipContainer = document.getElementById('kcsb_ship_container');
    let targetNodes = shipContainer.childNodes;
    let nodeList = [];
    targetNodes.forEach((node) => {
      nodeList.push(node);
    });
    nodeList.sort(sortComapreFunctions[sortType]);
    let shipContainerNew = shipContainer.cloneNode(false);
    nodeList.forEach((node) => {
      shipContainerNew.appendChild(node);
    });
    shipContainer.parentElement.replaceChild(shipContainerNew, shipContainer);
  }

  let updateHomeportView = function() {
    let shipContainerOld = document.getElementById('kcsb_ship_container');
    let shipContainer = shipContainerOld.cloneNode(false);
    shipContainerOld.parentNode.replaceChild(shipContainer, shipContainerOld);
    let dockDivList = [];
    ships.forEach((shipData, shipId) => {
      let dockDiv = document.createElement('div');
      dockDiv.className = 'kcsb_dock';
      dockDivList.push(dockDiv);
      let shipDiv = document.createElement('div');
      shipDiv.className = 'kcsb_item';
      shipDiv.id = getHomeportShipDivId(shipId);
      shipDiv.style.backgroundColor = shipColors[shipData.type];
      shipDiv.textContent = shipData.name + ' lv' + shipData.lv;
      updateShipSortieTags(shipDiv, Object.keys(shipData.sortieTags));    
      shipDiv.customInfo = {
        shipId: shipId
      };
      dockDiv.appendChild(shipDiv);
    });
    const sortSelector = document.getElementById('sort_selector');
    const sortType = sortSelector.value;
    dockDivList.sort(sortComapreFunctions[sortType]);
    dockDivList.forEach((dockDiv) => {
      shipContainer.appendChild(dockDiv);
    });
    $('.kcsb_item').draggable({
      start: function(e,ui) {
        let currentOffset = $(this).offset();
        this.customInfo.offsetOrg = {
          top: currentOffset.top,
          left: currentOffset.left
        };
      },
      stop: function(e,ui) {
        $(this).offset(this.customInfo.offsetOrg);
      }
    });
  }

  let updateShipSortieTags = function(shipDiv, shipSortieTags) {
    if(null === shipDiv) {
      return;
    }
    const extagNode = shipDiv.childNodes[1];
    if(extagNode) {
      shipDiv.removeChild(extagNode);
    }
    if(0 < shipSortieTags.length) {
      shipDiv.style.borderColor = sortieTags[shipSortieTags[0]].color;
      if(1 < shipSortieTags.length) {
        let sortieTagContainer = document.createElement('div');
        sortieTagContainer.style.position = 'absolute';
        sortieTagContainer.style.right = '0px';
        sortieTagContainer.style.top = '0px';
        for(let i=1; i<shipSortieTags.length; i++) {
          let sortieTagNode = document.createElement('div');
          sortieTagNode.style.width = '8px';
          sortieTagNode.style.height = '4px';
          sortieTagNode.style.backgroundColor = sortieTags[shipSortieTags[i]].color;
          sortieTagContainer.appendChild(sortieTagNode);
        }
        shipDiv.appendChild(sortieTagContainer);
      }
    } else {
      shipDiv.style.borderColor = '#000000';
    }
  }

  let getTaskForceDivId = function(taskforceId) {
    return 'taskforce_div_' + taskforceId;
  }

  let updateTaskForceStateView = function(taskforceId) {
    let taskforceDiv = document.getElementById(getTaskForceDivId(taskforceId));
    const taskforceData = taskforces[taskforceId];
    let hasMultipleSortieTags = false;
    const taskforceShipsLength = taskforceData.ships.length;
    for(let i=0; i<taskforceShipsLength; i++) {
      const shipData = ships[taskforceData.ships[i]];
      if(1 < Object.keys(shipData.sortieTags).length) {
        hasMultipleSortieTags = true;
        break;
      }
    }
    if(hasMultipleSortieTags) {
      taskforceDiv.style.backgroundColor = '#8f0404';
    } else {
      taskforceDiv.style.backgroundColor = '#1f337b';
    }
  }

  let updateShipView = function(shipId, triggerTaskForceId) {
    let shipData = ships[shipId];
    const sortieTags = Object.keys(shipData.sortieTags);
    updateShipSortieTags(document.getElementById(getHomeportShipDivId(shipId)), sortieTags);
    const taskforcesLength = taskforces.length;
    for(let taskforceId=0; taskforceId<taskforcesLength; taskforceId++) {
      if(triggerTaskForceId === taskforceId) {
        continue;
      }
      const taskforceData = taskforces[taskforceId];
      if(taskforceData.ships.includes(shipId)) {
        let taskforceShipDiv = document.getElementById(getTaskForceShipDivId(taskforceId, shipId));
        updateShipSortieTags(taskforceShipDiv, sortieTags);
        updateTaskForceStateView(taskforceId);
      }
    }
  }

  let updateOperationView = function() {
    let operationContainerOld = document.getElementById('kcsb_operation_container');
    let operationContainer = operationContainerOld.cloneNode(false);
    operationContainerOld.parentNode.replaceChild(operationContainer, operationContainerOld);
    let taskforceContainers = [];
    for(let i=0; i<operations.length; i++) {
      let operationData = operations[i];
      let operationDiv = document.createElement('div');
      operationDiv.className = 'kcsb_operation_area';
      operationDiv.id = 'kcsb_operation_' + i;
      operationContainer.appendChild(operationDiv);
      let operationLabel = document.createElement('p');
      operationLabel.className = 'kcsb_operation_label';
      operationLabel.textContent = operationData.name;
      $(operationLabel).click(function(){
        $(this).toggleClass('active');
        $(this).next('div').slideToggle();
      });
      operationDiv.appendChild(operationLabel);
      let taskforceContainer = document.createElement('div');
      taskforceContainer.className = 'kcsb_taskforce_container_area';
      operationDiv.appendChild(taskforceContainer);
      taskforceContainers.push(taskforceContainer);
    }
    for(let taskforceId=0; taskforceId<taskforces.length; taskforceId++) {
      let taskforceData = taskforces[taskforceId];
      if(!taskforceData.visible) {
        //continue;
      }
      let taskforceDiv = document.createElement('div');
      taskforceDiv.className = 'kcsb_taskforce_area';
      taskforceDiv.id = getTaskForceDivId(taskforceId);
      taskforceContainer = taskforceContainers[taskforceData.oprationId];
      taskforceContainer.appendChild(taskforceDiv);
      let taskforceLabel = document.createElement('p');
      taskforceLabel.textContent = taskforceData.name;
      taskforceLabel.style.borderColor = sortieTags[taskforceData.sortieTag].color;
      taskforceDiv.appendChild(taskforceLabel);
      let shipContainer = document.createElement('div');
      shipContainer.className = 'kcsb_taskforce_ship_area';
      taskforceDiv.appendChild(shipContainer);
      taskforceDiv.customInfo = {
        taskforceId: taskforceId
      }
      taskforceData.ships.forEach(function(shipId) {
        let shipDiv = createTaskForceShip(shipId, taskforceId);
        shipContainer.appendChild(shipDiv);
      });
      updateTaskForceStateView(taskforceId);
    }
    $('.kcsb_taskforce_area').droppable({
      activate: function(e,ui) {
      },
      over: function(e,ui) {
        //$(this)
        //  .css('background', '#e0ffff')
        //  .css('border', '2px solid #00bfff');
      },
      out: function(e,ui) {
      },
      drop: function(e,ui) {
        let shipDiv = ui.draggable[0];
        let shipContainer = $(this).find('.kcsb_taskforce_ship_area')[0];
        if(shipDiv.parentNode === shipContainer) {
          shipDiv.customInfo.canceled = true;
        }
        const shipId = shipDiv.customInfo.shipId;
        if(canDrop(this, shipId)) {
          const taskforceId = this.customInfo.taskforceId;
          let taskforceData = taskforces[taskforceId];
          appendTaskForceShip(taskforceId, shipId, function() { updateShipView(shipId, taskforceId); });
          let shipDiv2 = createTaskForceShip(shipId, taskforceId);
          shipContainer.appendChild(shipDiv2);
          updateTaskForceStateView(taskforceId);
        } else {
          shipDiv.customInfo.canceled = true;
        }
      }
    });
  }

  let canDrop = function(target, shipId) {
    // check taskforce tag
    if(!canRetainSortieTag(shipId, taskforces[target.customInfo.taskforceId].sortieTag)) {
      return false;
    }

    // check same ship existance
    let result = true;
    $(target).find('.kcsb_taskforce_ship').each(function(index, elem) {
      if(elem.customInfo.shipId === shipId) {
        result = false;
        return;
      }
    });
    return result;
  }

  let getTaskForceShipDivId = function(shipId, taskforceId) {
    return 'kcsb_taskforce_ship_div_' + taskforceId + '_' + shipId;
  }

  let createTaskForceShip = function(shipId, taskforceId) {
    let shipData = ships[shipId];
    let shipDiv = document.createElement('div');
    shipDiv.className = 'kcsb_taskforce_ship';
    shipDiv.id = getTaskForceShipDivId(taskforceId, shipId);
    shipDiv.style.backgroundColor = shipColors[shipData.type];
    shipDiv.textContent = shipData.name + ' lv' + shipData.lv;
    updateShipSortieTags(shipDiv, Object.keys(shipData.sortieTags));    
    shipDiv.customInfo = {
      shipId: shipId,
      taskforceId: taskforceId
    };
    $(shipDiv).draggable({
      start: function(e,ui) {
        let currentOffset = $(this).offset();
        this.customInfo.canceled = false;
        this.customInfo.offsetOrg = {
          top: currentOffset.top,
          left: currentOffset.left
        };
      },
      stop: function(e,ui) {
        if(this.customInfo.canceled) {
          $(this).offset(this.customInfo.offsetOrg);
        } else {
          this.parentNode.removeChild(this);
          const shipId = this.customInfo.shipId;
          removeTaskForceShip(taskforceId, shipId, function(){ updateShipView(shipId, taskforceId); });
          updateTaskForceStateView(taskforceId);
        }
      }
    });
    return shipDiv;
  }

  {
    let sortSelector = document.getElementById('sort_selector');
    sortSelector.addEventListener('change', (event) => {
      const value = event.target.value;
      sortHomeportView(value);
    });
  }

  {
    let viewSelector = document.getElementById('view_selector');
    viewSelector.addEventListener('change', (event) => {
      const value = event.target.value;
      const visibleHomeport = value.charAt(0) == '1';
      const visibleOperation = value.charAt(1) == '1';

      let homeportNode = document.getElementById('kcsb_ship_container');
      if(visibleHomeport) {
        homeportNode.style.display = 'flex';
        homeportNode.style.flexBasis = visibleOperation ? '50%' : '100%';
      } else {
        homeportNode.style.display = 'none';
      }

      let operationNode = document.getElementById('kcsb_operation_container');
      if(visibleOperation) {
        operationNode.style.display = 'inline';
        operationNode.style.flexBasis = visibleHomeport ? '50%' : '100%';
      } else {
        operationNode.style.display = 'none';
      }
    });
  }

  window.addEventListener('DOMContentLoaded', function(){
    postImport(true, true);
  });

</script>
</body>
</html>
